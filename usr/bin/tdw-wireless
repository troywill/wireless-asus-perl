#!/usr/bin/env perl
use warnings;
use strict;
# troydwill@gmail.com, June 2010

my $WIRELESS_DEVICE='wlan0';
my $ESSID='JM';
my $KEY='D21B5074EA';
# $ESSID='nunu';
# $KEY='644E4A6E39';

my $network_status = &get_network_status($WIRELESS_DEVICE);

while (1) {
    my $network_status = &get_network_status();
    if ( $network_status eq 'up' ) {
	print "."; sleep 1;
    } else {
	print "d";
	&up; sleep 1;
    }
}

sub get_network_status {
    chomp(my $network_status = `cat /sys/class/net/$WIRELESS_DEVICE/operstate`);
    return $network_status;
}

sub up {
     system("/sbin/ip link set ${WIRELESS_DEVICE} up");
     &set_essid ( ${WIRELESS_DEVICE}, ${ESSID});
     &set_key ( ${WIRELESS_DEVICE}, ${KEY});
#    system("/sbin/ip route add default via ${GATEWAY_IP_ADDRESS} dev ${WIRELESS_DEVICE}");
}

sub set_essid {
    my ( $wireless_device, $essid ) = @_;
    my $command = "/usr/sbin/iwconfig $wireless_device essid $essid";
    print "=> $command\n";
    system $command;
    sleep 3;
}

sub set_key {
    my ( $wireless_device, $key ) = @_;
    my $command = "/usr/sbin/iwconfig $wireless_device key $key";
    print "=> $command\n";
    system $command;
    sleep 3;
}
